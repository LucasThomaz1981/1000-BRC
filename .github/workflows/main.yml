name: 1000-BRC Pool System - Persistent

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *' # Executa a cada 4 horas para manter os checkpoints frescos

permissions:
  contents: write # Permite que o worker grave os checkpoints no repositório

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        worker: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necessário para fazer push dos checkpoints

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar Dependências de Sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y libgmp3-dev libssl-dev

      - name: Instalar Bibliotecas Python
        run: |
          pip install requests bitcoinlib

      - name: Executar Varredura
        timeout-minutes: 340
        env:
          WORKER_ID: ${{ matrix.worker }}
          TOTAL_WORKERS: 20
        run: |
          chmod +x run_worker.sh
          # Cria pasta de checkpoints se não existir
          mkdir -p checkpoints
          ./run_worker.sh

      - name: Salvar Progresso (Git Push Checkpoints)
        if: always() # Executa mesmo que o script de varredura seja cancelado
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # Adiciona apenas os checkpoints do worker específico para evitar conflitos de merge
          git pull origin main --rebase
          git add checkpoints/worker_${{ matrix.worker }}.txt
          git commit -m "Worker ${{ matrix.worker }}: checkpoint atualizado" || exit 0
          git push origin main
