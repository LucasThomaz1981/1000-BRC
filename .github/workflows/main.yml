name: 1000-BRC Pool System - Persistent

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        worker: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
    
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar Dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y libgmp3-dev libssl-dev
          pip install requests bitcoinlib

      # --- CORREÇÃO 1: GARANTIR QUE O ARQUIVO EXISTA ---
      # Se o arquivo estiver no seu repositório, este passo garante que ele seja movido para a raiz
      - name: Verificar MASTER_POOL.txt
        run: |
          if [ ! -f "MASTER_POOL.txt" ]; then
            echo "❌ Erro: MASTER_POOL.txt não encontrado no repositório!"
            exit 1
          fi

      - name: Executar Varredura
        timeout-minutes: 340
        env:
          WORKER_ID: ${{ matrix.worker }}
          TOTAL_WORKERS: 20
        run: |
          chmod +x run_worker.sh
          mkdir -p checkpoints
          # Rodar com python -u para log em tempo real
          python3 -u api_broadcast_system.py

      # --- CORREÇÃO 2: GIT PUSH SEGURO ---
      - name: Salvar Progresso (Git Push Checkpoints)
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Stash mudanças temporárias para permitir o rebase
          git stash
          git pull origin main --rebase
          git stash pop || echo "Sem mudanças para recuperar"
          
          mkdir -p checkpoints
          git add checkpoints/worker_${{ matrix.worker }}.txt
          git commit -m "Worker ${{ matrix.worker }}: checkpoint atualizado" || exit 0
          git push origin main
